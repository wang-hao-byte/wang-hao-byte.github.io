---
title: "进程内存分布详解"
published: 2025-08-04
description: "详解进程内存的各个分区结构、功能特点及管理机制"
tags: [系统编程]
category: "操作系统"
draft: false 
lang: "zh-CN"
---
## 1.进程内存分布

​	进程的内存分布是操作系统为每个进程分配的虚拟地址空间的分区结构，是操作系统分配资源的一部分，以下是进程的内存分布图

![](https://raw.githubusercontent.com/wang-hao-byte/FigureBed/master/202508042347301.png)

### 1.1代码段

.text Code Segment

- **核心功能**：存储CPU可执行的机器指令
- **包含内容**
  - 所有函数的二进制实现
  - 控制流指令(跳转、分支、循环的二进制码)
- **内存属性**：
  - 只读(防止程序意外修改指令，如缓冲区溢出改写代码)
  - 可执行(给CPU权限执行指令)
  - 可共享(多个进程可以执行同一份代码)
- 与文件的关系
  - 直接映射自可执行文件的.text段 //TODO
  - 占用磁盘空间(存储二进制指令)

### 1.2数据段

.data Data Segment

- **核心功能**：存储==已初始化且非0的全局变量和静态变量==
- 包含内容：
  - 静态变量(包含静态局部\全局变量)
  - 全局变量(初始值不为0的全局变量)
- 内存属性
  - 可读写：进程运行时可以修改
  - 私有：每个进程拥有独立副本
- 与文件关系
  - 映射可执行文件data段(编译时记录变量初始值)
  - 占用磁盘空间(存储初始值)

### 1.3BSS段

.bss  Block started by Symbol

- **核心功能**：存储==未初始化==或初始化为0的全局或静态变量
- 包含内容:
  - 未初始化的静态/全局变量(使用时未赋值)
  - 初始化为0的静态/全局变量(编译器优化，0值无需存储)
- 内存属性：
  - 可读写(同.data位置)
  - 私有(同.data位置)
- 与文件的关系：
  - 可执行文件中记录变量的大小和位置(不占用磁盘)
  - 符号表中标记"COMMON"类型(链接时确定最终地址)
- 初始化时机：程序加载时，操作系统统一清零

### 1.4堆

向上增长、地址由低到高

- **核心功能**：动态内存分配(需要手动申请和释放)
- 包含内容：
  - 动态分配的数组、结构体、对象
  - 变长数据(运行时确认大小的字符串、缓冲区)
- 内存属性
  - 可读可写
  - 私有：每个进程独立
- 管理机制
  - 由内存分配器(如：glibc的ptmalloc、Win的HeapAlloc)管理
  - 分配器通过"内存块+元数据"管理：每个分配的内存前有大小、状态等信息
  - 存在内存碎片等问题(频繁分配、释放小块内存导致连续空间无法使用)
- 与操作系统交互
  - 初始堆大小较小、不够时通过brk()\sbrk()系统调用向内核申请扩展
  - 大内存分配(如超过128kb)，直接通过mmap映射匿名内存页
- 生命周期
  - 由程序员控制，未释放会导致内存泄漏

eg:

```c++
int* arr = (int*)malloc(10*sizeof(int));//分配10个int类型
char* str = new char[100];//分配100个char类型
free(arr),delete[] str;
```

### 1.5内存映射段

Memory Mapping Segment

- **核心功能**：映射文件、共享库到内存，实现文件即内存的访问方式
- 包含内容
  - 动态库(如：.so/.dll，如libc标准C库的代码段和数据段)
  - 共享内存(通过shmat(),映射的IPC共享内存)
  - 文件映射(通过mmap将磁盘文件直接映射到内存)
  - 匿名映射(无对应文件的内存，如大内存分配的匿名页)
- 内存属性
  - 共享库代码段：只读、可执行、可共享
  - 共享内存区：可读可写私有(写时拷贝)
  - 文件映射：可配置为只读、可读写，修改后可以通过msync()写到磁盘
- 关键机制：
  - 写时拷贝：共享库数据段被多进程共享，某个进程修改时，内核为其创建私有副本
- 空闲内存区域
  - 作为堆栈的扩展区

### 1.6栈

向下生长(由低到高)

- **核心内容**：支持函数调用、存储函数上下午和临时数据。

- 包含内容(栈帧结构、从高到低)

  - 函数返回地址->函数执行完回到下一条指令地址。
  - 上一栈帧基帧(EBP/RBP)->保存调用者的栈帧基址，用于回溯。
  - 局部变量
  - 函数参数
  - 临时数据(表达式计算的中间结果)

- 内存属性

  - 可读写
  - 私有

- 管理机制

  - 由编译器自动管理：函数调用时”压栈“，返回时”出栈“
  - 栈指针(ESP/RSP)：指向栈顶的当前位置
  - 栈大小固定(默认8MB，可通过ulimit - s修改)，超出会栈溢出(Stack Overflow)

- 栈帧示例

  - 栈帧示例（调用func(1,2)时）： 

  ```plaintext
  | 高地址 →   0xffffd000: [返回地址]  → 0x08048500（调用者下一条指令）       |
  |           0xffffcffc: [上一EBP]   → 0xffffd010（调用者的EBP）          |
  |           0xffffcff8: [局部变量a] → 10（func内的int a=10;）            |
  |           0xffffcff4: [局部变量b] → 'c'（func内的char b='c';）         |
  |           0xffffcff0: [参数2]     → 2（func的第二个参数）              |
  |           0xffffcfee: [参数1]     → 1（func的第一个参数）              |
  | 低地址 →   0xffffcffc: [栈指针ESP]  → 指向参数1下方                     |
  ```

### 1.7环境变量区

Environment Variables

- **核心功能**：存储进程的环境变量
- 包含内容：
  - 系统的环境变量：PATH、HOME、LANG
  - 自定义环境变量：如程序设置的"APP_CONFIG=/etc/config"

### 1.8命令行参数区

Command Line Arguments 高地址->内核

- **核心功能**：存储程序启动时的命令行参数
- 包含内容：
  - argv[0]：程序自身路径（如"./a.out"）
  - argv[1..n]：用户输入的参数（如执行"./prog -v file.txt"时的"-v"和"file.txt"）
- 与main函数的关系：
  - main(int argc, char** argv)中的argv即指向该区域 